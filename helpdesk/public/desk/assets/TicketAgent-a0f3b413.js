import{s as le,_ as re}from"./formCustomisation-0b9b247f.js";import{r as B,h as t,ao as ce,o as d,k as M,t as L,F as K,aa as O,f as v,v as Q,d as N,m as X,n as ue,B as _,Z as P,V as H,ap as de,ab as W,w as k,l as x,s as Y,g as r,y as T,J as ee,e as R,ad as me,an as pe,X as fe,K as ke,O as ve,a5 as Z,a6 as ge,x as ye,q as be,b as _e,a8 as we,Y as xe,U as he}from"./index-04936222.js";import{_ as $e}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-b56e310e.js";import{_ as Te}from"./Dropdown.vue_vue_type_script_setup_true_lang-7c445c44.js";import{a as Ve,_ as Ae,T as Ce,A as je,C as Se,b as Ie,c as Ue,d as Me,e as Be,f as Ee,g as Re}from"./TicketAgentFields-805301e8.js";import{T as De,u as Fe}from"./useView-0740861b.js";import"./more-horizontal-1bcf38b1.js";import"./dayjs-5f17143d.js";import{_ as qe}from"./LayoutHeader-23b7e4b0.js";import{_ as Oe}from"./FadedScrollableDiv.vue_vue_type_script_setup_true_lang-5f800415.js";import{_ as Pe,E as He}from"./TicketFeedback.vue_vue_type_script_setup_true_lang-3d86481f.js";import{_ as Le,u as Ne,I as G}from"./ticketStatus-0753d42d.js";import"./knowledgeBase-3a84fed8.js";import{_ as ze}from"./Link-22744168.js";import{L as te}from"./merge-8f697033.js";import{g as Je}from"./globalStore-bbc6a779.js";import"./FileUploader-38365a62.js";import"./AttachmentItem.vue_vue_type_script_setup_true_lang-9f4d9f38.js";import"./UserAvatar.vue_vue_type_script_setup_true_lang-5247534f.js";import"./Avatar.vue_vue_type_script_setup_true_lang-d3cc4d2c.js";import"./agent-5f280df1.js";import"./Autocomplete-3be040f4.js";import"./EmailContent-05c09618.js";import"./StarRating.vue_vue_type_script_setup_true_lang-52da515c.js";const Ke={__name:"Icon",props:{icon:{type:[String,Object],required:!0}},setup(p){return(w,g)=>{const b=B("FeatherIcon");return t(ce)(p.icon)?(d(),M("div",K(O({key:0},w.$attrs)),L(p.icon),17)):typeof p.icon=="string"?(d(),v(b,O({key:1,name:p.icon},w.$attrs),null,16,["name"])):(d(),v(Q(p.icon),K(O({key:2},w.$attrs)),null,16))}}},Xe={class:"flex flex-col gap-4"},Ye={class:"text-p-base text-ink-gray-8"},Ze={class:"whitespace-nowrap font-semibold"},Ge={class:"flex items-center gap-2 rounded-md p-2 ring-1 ring-gray-200"},Qe=N({__name:"TicketMergeModal",props:X({ticket:{}},{modelValue:{type:Boolean},modelModifiers:{}}),emits:X(["update"],["update:modelValue"]),setup(p,{emit:w}){const g=p,b=w,V=ue(p,"modelValue");function A(){const u={status:["in",["Open","Replied"]],is_merged:0,name:["!=",g.ticket.name]};return g.ticket.customer&&(u.customer=g.ticket.customer),g.ticket.raised_by&&(u.raised_by=["like",`%${g.ticket.raised_by}%`]),u}const m=_(null),l=_(null),c=P({url:"helpdesk.helpdesk.doctype.hd_ticket.api.merge_ticket",makeParams({source:u,target:i}){return{source:u,target:i}},validate({source:u,target:i}){if(!u)throw{message:"Category is required"};if(!i)throw{message:"Ticket to merged with is required"}},onSuccess:()=>{H({title:"Ticket merged successfully",icon:"check",iconClasses:"text-green-600"}),b("update"),V.value=!1,window.open(window.location.origin+"/helpdesk/tickets/"+m.value,"_blank"),m.value=null}}),S=de({doctype:"HD Ticket",filters:{name:["=",m]},fields:["subject"],onSuccess:u=>{u.length>0&&(l.value=u[0].subject)}});W(()=>m.value,u=>{u&&(S.update({filters:{name:["=",u]}}),S.reload())});function C(){c.submit({source:g.ticket.name,target:m.value})}return(u,i)=>{const U=ze,s=B("FormControl"),D=B("Button");return d(),v(t(ee),{options:{title:"Merge with another ticket"},modelValue:V.value,"onUpdate:modelValue":i[2]||(i[2]=I=>V.value=I)},{"body-content":k(()=>[x("div",Xe,[x("p",Ye,[i[3]||(i[3]=Y(" All comments and emails of the ticket ")),x("span",Ze,"#"+L(u.ticket.name),1),i[4]||(i[4]=Y(" will be moved to the selected ticket. "))]),r(U,{class:"form-control",doctype:"HD Ticket",placeholder:"Select Ticket",filters:A(),label:"Ticket","page-length":10,value:m.value,"show-description":!0,onChange:i[0]||(i[0]=I=>m.value=String(I))},null,8,["filters","value"]),m.value?(d(),v(s,{key:0,label:"Ticket Subject",type:"text",modelValue:l.value,"onUpdate:modelValue":i[1]||(i[1]=I=>l.value=I),disabled:!0},null,8,["modelValue"])):T("",!0),x("div",Ge,[r(t(De),{class:"h-6 w-5 w-min-5 w-max-5 min-h-5 max-w-5 text-yellow-500"}),i[5]||(i[5]=x("div",{class:"text-wrap text-sm text-gray-700"}," This action is irreversible. ",-1))])])]),actions:k(()=>[r(D,{class:"w-full",variant:"solid",label:m.value?`Merge with ticket #${m.value} `:"Select Ticket",loading:t(c).loading,"icon-left":m.value&&t(te),onClick:C},null,8,["label","loading","icon-left"])]),_:1},8,["modelValue"])}}}),We={class:"flex w-[382px] flex-col justify-between border-l"},et={class:"flex h-10.5 items-center border-b px-5 py-2.5 text-lg font-medium text-ink-gray-9 justify-between"},tt=N({__name:"TicketAgentSidebar",props:{ticket:{}},emits:["update","email:open","reload"],setup(p,{emit:w}){const g=p,b=w;function V(l=null){var c;l.value&&typeof l.value=="object"&&(l.value=((c=l.value.target)==null?void 0:c.value)||null),b("update",l)}const A=_(!1),m=R(()=>!g.ticket.is_merged&&["Open","Replied"].includes(g.ticket.status));return(l,c)=>{const S=B("Button"),C=Le,u=Pe;return d(),M("div",We,[x("div",et,[x("span",{class:"cursor-copy text-lg font-semibold",onClick:c[0]||(c[0]=i=>t(me)(l.ticket.name,l.ticket.name))},"#"+L(l.ticket.name),1),m.value?(d(),v(C,{key:0,options:[{label:"Merge Ticket",onClick:()=>A.value=!0,icon:t(te),condition:()=>!l.ticket.is_merged}]},{default:k(()=>[r(S,{icon:"more-horizontal",class:"text-gray-600",variant:"ghost"})]),_:1},8,["options"])):T("",!0)]),r(Ve,{contact:l.ticket.contact,"onEmail:open":c[1]||(c[1]=i=>b("email:open",i))},null,8,["contact"]),l.ticket.feedback_rating?(d(),v(u,{key:0,class:"py-3 !px-6 !gap-3 text-base text-gray-600",ticket:l.ticket},null,8,["ticket"])):T("",!0),r(Ae,{ticket:l.ticket},null,8,["ticket"]),r(Ce,{ticket:l.ticket,onUpdate:V},null,8,["ticket"]),A.value?(d(),v(Qe,{key:1,ticket:l.ticket,modelValue:A.value,"onUpdate:modelValue":c[2]||(c[2]=i=>A.value=i),onUpdate:c[3]||(c[3]=i=>b("reload"))},null,8,["ticket","modelValue"])):T("",!0)])}}}),at={class:"flex flex-col"},ot={key:1},st={key:1,class:"flex h-full overflow-hidden"},nt={class:"flex flex-1 flex-col"},it={class:"overflow-y-hidden flex flex-1 !h-full flex-col"},lt={class:"flex flex-col flex-1 gap-3"},Ut=N({__name:"TicketAgent",props:{ticketId:{type:String,required:!0}},setup(p){const w=be(),g=_e(),b=Ne(),{getUser:V}=pe(),{$dialog:A}=Je(),m=_(null),l=_(null),c=_(""),S=_(!1),C=p;W(()=>C.ticketId,()=>{s.reload()});const{findView:u}=Fe("HD Ticket");we("communicationArea",l);const i=_(!1),U=_(!1),s=P({url:"helpdesk.helpdesk.doctype.hd_ticket.api.get_one",auto:!0,makeParams:()=>({name:C.ticketId}),transform:a=>{a._assign&&(a.assignees=JSON.parse(a._assign).map(e=>({name:e,image:V(e).user_image,label:V(e).full_name}))),c.value=a.subject},onSuccess:a=>{document.title=a.subject,le(a,{doc:a,call:he,router:g,$dialog:A,updateField:D,createToast:H})}});function D(a,e,j=()=>{}){E(a,e),j()}const I=R(()=>{var e,j,h,$;let a=[{label:"Tickets",route:{name:"TicketsAgent"}}];if(w.query.view){const f=u(w.query.view);f&&a.push({label:(e=f.value)==null?void 0:e.label,icon:fe((j=f.value)==null?void 0:j.icon),route:{name:"TicketsAgent",query:{view:(h=f.value)==null?void 0:h.name}}})}return a.push({label:($=s.data)==null?void 0:$.subject,onClick:()=>{U.value=!0}}),a}),ae=()=>{var a;c.value!==((a=s.data)==null?void 0:a.subject)&&(E("subject",c.value),U.value=!1)},oe=R(()=>b.options.map(a=>({label:a,value:a,onClick:()=>E("status",a),icon:()=>ke(G,{class:b.textColorMap[a]})}))),z=_(0),se=[{name:"activity",label:"Activity",icon:je},{name:"email",label:"Emails",icon:He},{name:"comment",label:"Comments",icon:Se}],J=R(()=>{const a=s.data.communications.map((o,n)=>({subject:o.subject,content:o.content,sender:{name:o.user.email,full_name:o.user.name},to:o.recipients,type:"email",key:o.creation,cc:o.cc,bcc:o.bcc,creation:o.creation,attachments:o.attachments,name:o.name,isFirstEmail:n===0})),e=s.data.comments.map(o=>({name:o.name,type:"comment",key:o.creation,commentedBy:o.commented_by,commenter:o.user.name,creation:o.creation,content:o.content,attachments:o.attachments})),j=[...s.data.history,...s.data.views].map(o=>({type:"history",key:o.creation,content:o.action?o.action:"viewed this",creation:o.creation,user:o.user.name+" "})),h=[...a,...e,...j].sort((o,n)=>new Date(o.creation)-new Date(n.creation)),$=[];let f=0;for(;f<h.length;){const o=h[f];if(o.type==="history"){o.relatedActivities=[];for(let n=f+1;n<h.length+1;n++){const y=h[n];if(y&&y.type==="history")o.relatedActivities.push(y);else{$.push(o),f=n-1;break}}}else $.push(o);f++}return $});function ne(a){return a==="activity"?J.value:J.value.filter(e=>e.type===a)}const F=_(!1);function E(a,e){e!==s.data[a]&&(ie(a,e),P({url:"frappe.client.set_value",params:{doctype:"HD Ticket",name:C.ticketId,fieldname:a,value:e},debounce:500,auto:!0,onSuccess:()=>{S.value=!1,F.value=!1,s.reload()},onError:()=>{F.value||(F.value=!0,s.reload())}}))}function ie(a,e){s.data[a]=e,H({title:"Ticket updated",icon:"check",iconClasses:"text-green-600"})}return ve(()=>{Z.on("helpdesk:ticket-update",a=>{a===Number(C.ticketId)&&s.reload()})}),ge(()=>{document.title="Helpdesk",Z.off("helpdesk:ticket-update")}),(a,e)=>{var f,o;const j=re,h=B("FeatherIcon"),$=B("Button");return d(),M("div",at,[t(s).data?(d(),v(t(qe),{key:0},{"left-header":k(()=>[r(t($e),{items:I.value,class:"breadcrumbs"},{prefix:k(({item:n})=>[n.icon?(d(),v(t(Ke),{key:0,icon:n.icon,class:"mr-1 h-4 flex items-center justify-center self-center"},null,8,["icon"])):T("",!0)]),_:1},8,["items"])]),"right-header":k(()=>{var n;return[t(s).data._customActions?(d(),v(j,{key:0,actions:t(s).data._customActions},null,8,["actions"])):T("",!0),(n=t(s).data.assignees)!=null&&n.length?(d(),M("div",ot,[(d(),v(Q(t(s).data.assignees.length==1?"Button":"div"),null,{default:k(()=>[r(t(Oe),{avatars:t(s).data.assignees,onClick:e[0]||(e[0]=y=>i.value=!0)},null,8,["avatars"])]),_:1}))])):(d(),M("button",{key:2,class:"rounded bg-gray-100 px-2 py-1.5 text-base text-gray-800",onClick:e[1]||(e[1]=y=>i.value=!0)}," Assign ")),r(t(Te),{options:oe.value},{default:k(({open:y})=>[r($,{label:t(s).data.status},{prefix:k(()=>[r(t(G),{class:ye(t(b).textColorMap[t(s).data.status])},null,8,["class"])]),suffix:k(()=>[r(h,{name:y?"chevron-up":"chevron-down",class:"h-4"},null,8,["name"])]),_:2},1032,["label"])]),_:1},8,["options"])]}),_:1})):T("",!0),t(s).data?(d(),M("div",st,[x("div",nt,[x("div",it,[r(t(Be),{modelValue:z.value,"onUpdate:modelValue":e[5]||(e[5]=n=>z.value=n),tabs:se},{default:k(()=>[r(t(Ie)),r(t(Ue),{class:"h-full"},{default:k(({tab:n})=>{var y;return[r(t(Me),{ref_key:"ticketAgentActivitiesRef",ref:m,activities:ne(n.name),title:n.label,"ticket-status":(y=t(s).data)==null?void 0:y.status,onUpdate:e[2]||(e[2]=()=>{t(s).reload()}),"onEmail:reply":e[3]||(e[3]=q=>{l.value.replyToEmail(q)}),"onEmail:forward":e[4]||(e[4]=q=>{l.value.forwardEmail(q)})},null,8,["activities","title","ticket-status"])]}),_:1})]),_:1},8,["modelValue"])]),(d(),v(t(Ee),{ref_key:"communicationAreaRef",ref:l,modelValue:t(s).data,"onUpdate:modelValue":e[6]||(e[6]=n=>t(s).data=n),"to-emails":[(f=t(s).data)==null?void 0:f.raised_by],"cc-emails":[],"bcc-emails":[],key:(o=t(s).data)==null?void 0:o.name,onUpdate:e[7]||(e[7]=()=>{t(s).reload(),m.value.scrollToLatestActivity()})},null,8,["modelValue","to-emails"]))]),r(t(tt),{ticket:t(s).data,onUpdate:e[8]||(e[8]=({field:n,value:y})=>E(n,y)),"onEmail:open":e[9]||(e[9]=n=>l.value.toggleEmailBox()),onReload:e[10]||(e[10]=n=>t(s).reload())},null,8,["ticket"])])):T("",!0),t(s).data?(d(),v(t(Re),{key:2,modelValue:i.value,"onUpdate:modelValue":e[11]||(e[11]=n=>i.value=n),assignees:t(s).data.assignees,docname:p.ticketId,doctype:"HD Ticket",onUpdate:e[12]||(e[12]=()=>{t(s).reload()})},null,8,["modelValue","assignees","docname"])):T("",!0),r(t(ee),{modelValue:U.value,"onUpdate:modelValue":e[14]||(e[14]=n=>U.value=n),options:{title:"Rename Subject"}},{"body-content":k(()=>[x("div",lt,[r(t(xe),{modelValue:c.value,"onUpdate:modelValue":e[13]||(e[13]=n=>c.value=n),type:"textarea",size:"sm",variant:"subtle",disabled:!1},null,8,["modelValue"]),r($,{variant:"solid",loading:S.value,label:"Rename",onClick:ae},null,8,["loading"])])]),_:1},8,["modelValue"])])}}});export{Ut as default};
//# sourceMappingURL=TicketAgent-a0f3b413.js.map
