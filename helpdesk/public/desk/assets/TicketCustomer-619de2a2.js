import{s as W,_ as X}from"./formCustomisation-1cf8df92.js";import{d as P,e as T,a3 as F,r as N,o as i,k as _,l as n,g as u,h as t,w as k,t as w,y as b,H as U,I as V,f as $,a4 as Y,N as H,Z as j,B as D,c as ee,a as te,O as ae,a5 as z,a6 as se,a7 as M,z as K,b as oe,V as E,a8 as ne,a9 as le,a2 as O,U as ie}from"./index-7cfac70d.js";import{_ as re}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-321ee831.js";import{g as ce}from"./globalStore-ea71a2d6.js";import{I as de}from"./useView-6086fe67.js";import{I as L}from"./symbols-7dbf6ecf.js";import"./more-horizontal-baf6d079.js";import{d as l}from"./dayjs-44da97f0.js";import{_ as ue}from"./LayoutHeader-ae45b9e1.js";import"./knowledgeBase-7671002e.js";import{_ as me}from"./TicketConversation.vue_vue_type_script_setup_true_lang-cef02eb9.js";import{_ as fe}from"./TicketCustomerTemplateFields.vue_vue_type_script_setup_true_lang-d9bb5ab8.js";import{_ as pe}from"./TicketTextEditor.vue_vue_type_script_setup_true_lang-b725ef40.js";import{_ as _e}from"./TicketFeedback.vue_vue_type_script_setup_true_lang-f9b97734.js";import{E as be,_ as ke}from"./TicketFeedback.vue_vue_type_script_setup_true_lang-81a165cf.js";import{_ as xe}from"./Avatar.vue_vue_type_script_setup_true_lang-c9c85df3.js";import"./Dropdown.vue_vue_type_script_setup_true_lang-78ec013f.js";import"./TicketCommunication.vue_vue_type_script_setup_true_lang-85ada8a5.js";import"./EmailContent-17494f66.js";import"./index-44160721.js";import"./AttachmentItem.vue_vue_type_script_setup_true_lang-33b905ab.js";import"./UserAvatar.vue_vue_type_script_setup_true_lang-161cf044.js";import"./FileUploader-027c469b.js";import"./StarRating.vue_vue_type_script_setup_true_lang-17a5994f.js";const ve={class:"flex w-[382px] flex-col border-l gap-4"},ge={class:"flex flex-col gap-4 pt-0 px-5 py-3 border-b"},ye={class:"flex gap-2"},he={class:"flex items-center justify-between"},Ce={class:"w-[242px] truncate text-2xl font-medium"},we={key:0,class:"flex gap-1.5"},$e={class:"flex items-center text-base leading-5"},Te={class:"w-[126px] text-sm text-gray-600"},Ie={class:"text-base text-gray-800 flex-1"},Se={class:"w-[126px] text-gray-600 text-sm"},De={class:"break-words text-base text-gray-800"},Be={class:"flex flex-col gap-4 pt-0 px-5 py-3"},Fe={class:"flex items-center text-base leading-5"},Ee={class:"w-[126px] text-sm text-gray-600"},je={class:"text-base text-gray-800 flex-1"},Ae=P({__name:"TicketCustomerSidebar",emits:["open"],setup(I,{emit:y}){const f=y,e=Y(L),x=T(()=>{const s=v(),r=m();return[{title:"First Response",value:e.data.first_responded_on||e.data.response_by,label:s.label,theme:s.color},{title:"Resolution",value:e.data.resolution_date||e.data.resolution_by,label:r.label,theme:r.color}]});function v(){let s=null;return!e.data.first_responded_on&&l().isBefore(l(e.data.response_by))?s={label:`Due in ${F(l(e.data.response_by).diff(l(),"s"))}`,color:"orange"}:l(e.data.first_responded_on).isBefore(l(e.data.response_by))?s={label:`Fulfilled in ${F(l(e.data.first_responded_on).diff(l(e.data.creation),"s"))}`,color:"green"}:s={label:"Failed",color:"red"},s}function m(){let s=null;return!e.data.resolution_date&&l().isBefore(e.data.resolution_by)?s={label:`Due in ${F(l(e.data.resolution_by).diff(l(),"s"))}`,color:"orange"}:l(e.data.resolution_date).isBefore(e.data.resolution_by)?s={label:`Fulfilled in ${F(l(e.data.resolution_date).diff(l(e.data.creation),"s"))}`,color:"green"}:s={label:"Failed",color:"red"},s}const h=T(()=>[{label:"Ticket ID",value:e.data.name},{label:"Status",value:B(e.data.status),bold:!0}]),g=T(()=>{const s=[{label:"Subject",value:e.data.subject},{label:"Team",value:e.data.agent_group||"-"},{label:"Priority",value:e.data.priority}],r=e.data.template.fields.filter(p=>!p.hide_from_customer&&["subject","team","priority"].indexOf(p.fieldname)===-1).map(p=>({label:p.label,value:e.data[p.fieldname]}));return[...s,...r]});function B(s){switch(s){case"Replied":return"Awaiting reply";default:return s}}return(s,r)=>{const p=be,S=N("Button"),A=N("Badge"),R=ke;return i(),_("div",ve,[r[1]||(r[1]=n("div",{class:"flex items-center justify-between border-b px-5 py-3"},[n("span",{class:"cursor-copy text-lg font-semibold"},"Ticket details")],-1)),n("div",ge,[n("div",ye,[u(t(xe),{size:"2xl",image:t(e).data.contact.image,label:t(e).data.contact.name},null,8,["image","label"]),n("div",he,[u(t(H),{text:t(e).data.contact.name},{default:k(()=>[n("div",Ce,w(t(e).data.contact.name),1)]),_:1},8,["text"]),t(e).data.feedback_rating?b("",!0):(i(),_("div",we,[u(t(H),{text:t(e).data.contact.email_id},{default:k(()=>[u(S,{class:"h-7 w-7",onClick:r[0]||(r[0]=c=>f("open"))},{default:k(()=>[u(p,{class:"h-4 w-4"})]),_:1})]),_:1},8,["text"])]))])]),(i(!0),_(U,null,V(h.value,c=>(i(),_("div",$e,[n("span",Te,w(c.label),1),n("span",Ie,w(c.value),1)]))),256)),(i(!0),_(U,null,V(x.value,c=>(i(),_("div",{key:c.label,class:"flex items-center text-base"},[n("div",Se,w(c.title),1),n("div",De,[u(t(H),{text:t(l)(c.value).long()},{default:k(()=>[u(A,{label:c.label,theme:c.theme,variant:"outline"},null,8,["label","theme"])]),_:2},1032,["text"])])]))),128))]),t(e).data.feedback_rating?(i(),$(R,{key:0,class:"border-b text-base text-gray-600",ticket:t(e).data},null,8,["ticket"])):b("",!0),n("div",Be,[(i(!0),_(U,null,V(g.value,c=>(i(),_("div",Fe,[n("span",Ee,w(c.label),1),n("span",je,w(c.value),1)]))),256))])])}}});function Re(I,y=!1,f,e,x){return j({url:"helpdesk.helpdesk.doctype.hd_ticket.api.get_one",cache:["Ticket",I],params:{name:I,is_customer_portal:y},auto:!0,transform:m=>{f&&f(m)},onSuccess:m=>{e&&e(m)},onError:m=>{console.log("here"),x&&x(m)}})}const Ue={key:0,class:"flex flex-col"},Ve={class:"flex overflow-hidden h-full"},He={class:"flex flex-col flex-1"},Ne=["onKeydownCapture"],ze="Type a message",ut=P({__name:"TicketCustomer",props:{ticketId:{}},setup(I){const y=oe(),f=I,e=Re(f.ticketId,!0,null,o=>{W(o,{doc:o,call:ie,router:y,$dialog:s,updateField:p,createToast:E})},()=>{E({title:"Ticket not found",icon:"x",iconClasses:"text-red-600"}),y.replace("/my-tickets")});ne(L,e);const x=D(null),v=D(""),m=D([]),h=D(!1),g=D(!1),{isMobileView:B}=ee(),{$dialog:s}=ce(),r=j({url:"run_doc_method",debounce:300,makeParams:()=>({dt:"HD Ticket",dn:f.ticketId,method:"create_communication_via_contact",args:{message:v.value,attachments:m.value}}),onSuccess:()=>{x.value.editor.commands.clearContent(!0),m.value=[],g.value=!1,e.reload()}});function p(o,a,C=()=>{}){A(o,a),C()}function S(){le(v.value)||r.loading||r.submit()}function A(o,a){j({url:"frappe.client.set_value",params:{doctype:"HD Ticket",name:f.ticketId,fieldname:o,value:a},auto:!0,onSuccess:()=>{e.reload(),E({title:"Ticket updated",icon:"check",iconClasses:"text-green-600"})}})}function R(){Q.value?h.value=!0:c()}function c(){s({title:"Close Ticket",message:"Are you sure you want to close this ticket?",actions:[{label:"Confirm",variant:"solid",onClick(o){e.data.status="Closed",Z.submit({fieldname:"status",value:"Closed"},{onSuccess:()=>{E({title:"Ticket closed successfully",icon:"check",iconClasses:"text-green-600",position:"top-right"})}}),o()}}]})}const Z=j({url:"frappe.client.set_value",debounce:300,makeParams:o=>({doctype:"HD Ticket",name:f.ticketId,fieldname:o.fieldname,value:o.value}),onSuccess:()=>{h.value=!1,e.reload()}}),q=T(()=>{var a;let o=[{label:"Tickets",route:{name:"TicketsCustomer"}}];return o.push({label:(a=e.data)==null?void 0:a.subject,route:{name:"TicketCustomer"}}),o}),G=T(()=>e.data.status!=="Closed"),{isFeedbackMandatory:J}=te(),Q=T(()=>{var a,C;return((C=(a=e.data)==null?void 0:a.communications)==null?void 0:C.some(d=>d.sender!==e.data.raised_by))&&J});return ae(()=>{document.title=f.ticketId,z.on("helpdesk:ticket-update",o=>{o===Number(f.ticketId)&&e.reload()})}),se(()=>{document.title="Helpdesk",z.off("helpdesk:ticket-update")}),(o,a)=>{const C=X;return t(e).data?(i(),_("div",Ue,[u(t(ue),null,{"left-header":k(()=>[u(t(re),{items:q.value},null,8,["items"])]),"right-header":k(()=>[t(e).data._customActions?(i(),$(C,{key:0,actions:t(e).data._customActions},null,8,["actions"])):b("",!0),t(e).data.status!=="Closed"?(i(),$(t(O),{key:1,label:"Close",theme:"gray",variant:"solid",onClick:a[0]||(a[0]=d=>R())},{prefix:k(()=>[u(t(de),{icon:"lucide:check"})]),_:1})):b("",!0)]),_:1}),n("div",Ve,[n("section",He,[t(B)?(i(),$(fe,{key:0})):b("",!0),u(me,{class:"grow"}),n("div",{class:"m-5",onKeydownCapture:[M(K(S,["ctrl","stop"]),["enter"]),M(K(S,["meta","stop"]),["enter"])]},[G.value?(i(),$(pe,{key:0,ref_key:"editor",ref:x,attachments:m.value,"onUpdate:attachments":a[1]||(a[1]=d=>m.value=d),content:v.value,"onUpdate:content":a[2]||(a[2]=d=>v.value=d),expand:g.value,"onUpdate:expand":a[3]||(a[3]=d=>g.value=d),placeholder:ze,autofocus:"",onClear:a[4]||(a[4]=()=>g.value=!1)},{"bottom-right":k(()=>{var d;return[u(t(O),{label:"Send",theme:"gray",variant:"solid",disabled:((d=o.$refs.editor)==null?void 0:d.editor.isEmpty)||t(r).loading,loading:t(r).loading,onClick:S},null,8,["disabled","loading"])]}),_:1},8,["attachments","content","expand"])):b("",!0)],40,Ne)]),t(B)?b("",!0):(i(),$(Ae,{key:0,onOpen:a[5]||(a[5]=d=>g.value=!0)}))]),u(_e,{open:h.value,"onUpdate:open":a[6]||(a[6]=d=>h.value=d)},null,8,["open"])])):b("",!0)}}});export{ut as default};
//# sourceMappingURL=TicketCustomer-619de2a2.js.map
