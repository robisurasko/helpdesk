{"version":3,"file":"formCustomisation-0b9b247f.js","sources":["../../../../desk/src/components/CustomActions.vue","../../../../desk/src/composables/formCustomisation.ts"],"sourcesContent":["<template>\n  <div v-if=\"normalActions.length\" class=\"flex gap-2\">\n    <Button\n      v-for=\"action in normalActions\"\n      :key=\"action.label\"\n      :label=\"action.label\"\n      @click=\"action.onClick()\"\n    >\n      <template v-if=\"action.icon\" #prefix>\n        <FeatherIcon :name=\"action.icon\" class=\"h-4 w-4\" />\n      </template>\n    </Button>\n  </div>\n  <Dropdown v-if=\"groupedActions.length\" :options=\"groupedActions\">\n    <Button icon=\"more-horizontal\" />\n  </Dropdown>\n  <div v-if=\"groupedWithLabelActions.length\">\n    <div v-for=\"g in groupedWithLabelActions\" :key=\"g.label\">\n      <Dropdown v-slot=\"{ open }\" :options=\"g.action\">\n        <Button :label=\"g.label\">\n          <template #suffix>\n            <FeatherIcon\n              :name=\"open ? 'chevron-up' : 'chevron-down'\"\n              class=\"h-4\"\n            />\n          </template>\n        </Button>\n      </Dropdown>\n    </div>\n  </div>\n</template>\n\n<script setup>\nimport { computed, h } from \"vue\";\nimport { Dropdown } from \"frappe-ui\";\n\nconst props = defineProps({\n  actions: {\n    type: Object,\n    required: true,\n  },\n});\n\nconst normalActions = computed(() => {\n  return props.actions.filter((action) => !action.group);\n});\n\nconst groupedWithLabelActions = computed(() => {\n  let _actions = [];\n\n  props.actions\n    .filter((action) => action.buttonLabel && action.group)\n    .forEach((action) => {\n      let groupIndex = _actions.findIndex(\n        (a) => a.label === action.buttonLabel\n      );\n      if (groupIndex > -1) {\n        _actions[groupIndex].action.push(action);\n      } else {\n        _actions.push({\n          label: action.buttonLabel,\n          action: [action],\n        });\n      }\n    });\n  return _actions;\n});\n\nconst groupedActions = computed(() => {\n  let _actions = [];\n  _actions = _actions.concat(\n    props.actions.filter((action) => action.group && !action.buttonLabel)\n  );\n  return _actions;\n});\n</script>\n","import { Field } from \"@/types\";\n\nexport function setupCustomizations(data, obj) {\n  if (!data._form_script) return [];\n  let actions = [];\n  let onChangeFieldMap = {};\n  if (Array.isArray(data._form_script)) {\n    data._form_script.forEach((script) => {\n      const parsed = parseScript(script, obj);\n      actions = actions.concat(parsed.actions);\n      if (parsed.onChange) {\n        parseOnChangeFn(onChangeFieldMap, parsed.onChange);\n      }\n    });\n  } else {\n    const parsed = parseScript(data._form_script, obj);\n    actions = parsed.actions;\n    if (parsed.onChange) {\n      parseOnChangeFn(onChangeFieldMap, parsed.onChange);\n    }\n  }\n  data._customActions = actions;\n  if (Object.keys(onChangeFieldMap).length) {\n    data._customOnChange = onChangeFieldMap;\n  }\n}\n\nfunction parseOnChangeFn(fieldMap: object, currentField: object) {\n  for (const [key, value] of Object.entries(currentField)) {\n    if (!fieldMap[key]) {\n      fieldMap[key] = new Set();\n    }\n    fieldMap[key].add(value);\n  }\n}\n\nfunction parseScript(script, obj) {\n  const scriptFn = new Function(script + \"\\nreturn setupForm\")();\n  const formScript = scriptFn(obj);\n  return {\n    actions: formScript?.actions || [],\n    onChange: formScript?.onChange || null,\n  };\n}\n\nexport function handleSelectFieldUpdate(\n  f: Field,\n  fieldname: string,\n  filters: any,\n  doc: any,\n  oldDoc: any\n) {\n  if (!filters) {\n    f.options = oldDoc.find((f) => f.fieldname === fieldname).options;\n  } else {\n    f.options = filters.join(\"\\n\");\n  }\n\n  // reset dependent field\n  doc[fieldname] = \"\";\n}\n\nexport function handleLinkFieldUpdate(\n  f: Field,\n  fieldname: string,\n  filters: any,\n  doc: any,\n  oldDoc: any\n) {\n  if (!filters) {\n    f.link_filters = oldDoc.find((f) => f.fieldname === fieldname).link_filters;\n    return;\n  }\n  f.link_filters = JSON.stringify([[f.options, \"name\", \"in\", filters]]);\n\n  // reset dependent field\n  doc[fieldname] = \"\";\n}\n\n//\nexport function parseField(field, doc) {\n  return {\n    display_via_depends_on: evaluateDependsOnValue(field?.depends_on, doc),\n    ...field,\n    required:\n      field.required ||\n      (field.mandatory_depends_on &&\n        evaluateDependsOnValue(field.mandatory_depends_on, doc)),\n    filters: field.link_filters && JSON.parse(field.link_filters),\n  };\n}\nfunction evaluateDependsOnValue(expression, doc) {\n  if (!expression) return true;\n  let out = null;\n  if (expression.substr(0, 5) == \"eval:\") {\n    try {\n      out = _eval(expression.substr(5), { doc });\n    } catch (e) {\n      out = true;\n    }\n  } else if (expression.substr(0, 4) == \"doc.\") {\n    out = doc[expression.substr(4)];\n  } else {\n    let value = doc[expression];\n    if (Array.isArray(value)) {\n      out = !!value.length;\n    } else {\n      out = !!value;\n    }\n  }\n  return out;\n}\nfunction _eval(code, context = {}) {\n  let variable_names = Object.keys(context);\n  let variables = Object.values(context);\n  code = `let out = ${code}; return out`;\n  try {\n    let expression_function = new Function(...variable_names, code);\n    return expression_function(...variables);\n  } catch (error) {\n    console.log(\"Error evaluating the following expression:\");\n    console.error(code);\n    throw error;\n  }\n}\n"],"names":["props","__props","normalActions","computed","action","groupedWithLabelActions","_actions","groupIndex","a","groupedActions","setupCustomizations","data","obj","actions","onChangeFieldMap","script","parsed","parseScript","parseOnChangeFn","fieldMap","currentField","key","value","formScript","handleSelectFieldUpdate","f","fieldname","filters","doc","oldDoc","handleLinkFieldUpdate","parseField","field","evaluateDependsOnValue","expression","out","_eval","code","context","variable_names","variables","error"],"mappings":"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"}