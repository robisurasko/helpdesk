{"version":3,"file":"TicketNew-bcc404e9.js","sources":["../../../../desk/src/components/UniInput.vue","../../../../desk/src/pages/ticket/TicketNew.vue"],"sourcesContent":["<template>\n  <div class=\"space-y-1.5\" v-if=\"field.display_via_depends_on\">\n    <span class=\"block text-sm text-gray-700\">\n      {{ field.label }}\n      <span v-if=\"field.required\" class=\"place-self-center text-red-500\">\n        *\n      </span>\n    </span>\n    <component\n      :is=\"component\"\n      :placeholder=\"placeholder\"\n      :value=\"transValue\"\n      :model-value=\"transValue\"\n      @update:model-value=\"emitUpdate(field.fieldname, $event)\"\n      @change=\"\n        emitUpdate(\n          field.fieldname,\n          $event.target?.value || $event.value || $event\n        )\n      \"\n    />\n  </div>\n</template>\n\n<script setup lang=\"ts\">\nimport { computed, h } from \"vue\";\nimport { Autocomplete, Link } from \"@/components\";\nimport { createResource, FormControl } from \"frappe-ui\";\nimport { Field } from \"@/types\";\n\ntype Value = string | number | boolean;\n\ninterface P {\n  field: Field;\n  value: Value;\n}\n\ninterface R {\n  fieldname: Field[\"fieldname\"];\n  value: Value;\n}\n\ninterface E {\n  (event: \"change\", value: R);\n}\n\nconst props = defineProps<P>();\nconst emit = defineEmits<E>();\n\nconst component = computed(() => {\n  if (props.field.url_method) {\n    return h(Autocomplete, {\n      options: apiOptions.data,\n    });\n  } else if (props.field.fieldtype === \"Link\" && props.field.options) {\n    return h(Link, {\n      doctype: props.field.options,\n      filters: props.field.filters,\n    });\n  } else if (props.field.fieldtype === \"Select\") {\n    return h(Autocomplete, {\n      options: props.field.options\n        .split(\"\\n\")\n        .map((o) => ({ label: o, value: o })),\n    });\n  } else if (props.field.fieldtype === \"Check\") {\n    return h(Autocomplete, {\n      options: [\n        {\n          label: \"Yes\",\n          value: 1,\n        },\n        {\n          label: \"No\",\n          value: 0,\n        },\n      ],\n    });\n  } else {\n    return h(FormControl, {\n      debounce: 500,\n    });\n  }\n});\n\nconst apiOptions = createResource({\n  url: props.field.url_method,\n  auto: !!props.field.url_method,\n  transform: (data) =>\n    data.map((o) => ({\n      label: o,\n      value: o,\n    })),\n});\n\nconst transValue = computed(() => {\n  if (props.field.fieldtype === \"Check\") {\n    return props.value ? \"Yes\" : \"No\";\n  }\n  return props.value;\n});\n\nconst placeholder = computed(() => {\n  if (props.field.fieldtype === \"Data\" && !props.field.url_method) {\n    return \"Type something\";\n  }\n  return \"Select an option\";\n});\n\nfunction emitUpdate(fieldname: Field[\"fieldname\"], value: Value) {\n  emit(\"change\", { fieldname, value });\n}\n</script>\n","<template>\n  <div class=\"flex flex-col overflow-y-auto\">\n    <LayoutHeader>\n      <template #left-header>\n        <Breadcrumbs :items=\"breadcrumbs\" />\n      </template>\n      <template #right-header>\n        <CustomActions\n          v-if=\"template.data?._customActions\"\n          :actions=\"template.data?._customActions\"\n        />\n      </template>\n    </LayoutHeader>\n    <!-- Container -->\n    <div\n      class=\"flex flex-col gap-5 py-6 h-full flex-1 self-center overflow-auto mx-auto w-full max-w-4xl px-5\"\n    >\n      <!-- custom fields descriptions -->\n      <div v-if=\"Boolean(template.data?.about)\" class=\"\">\n        <div class=\"prose-f\" v-html=\"sanitize(template.data.about)\" />\n      </div>\n      <!-- custom fields -->\n      <div\n        class=\"grid grid-cols-1 gap-4 sm:grid-cols-3\"\n        v-if=\"Boolean(visibleFields)\"\n      >\n        <UniInput\n          v-for=\"field in visibleFields\"\n          :key=\"field.fieldname\"\n          :field=\"field\"\n          :value=\"templateFields[field.fieldname]\"\n          @change=\"\n            (e) => handleOnFieldChange(e, field.fieldname, field.fieldtype)\n          \"\n        />\n      </div>\n      <!-- existing fields -->\n      <div\n        class=\"flex flex-col\"\n        :class=\"(subject.length >= 2 || description.length) && 'gap-5'\"\n      >\n        <div class=\"flex flex-col gap-2\">\n          <span class=\"block text-sm text-gray-700\">\n            Subject\n            <span class=\"place-self-center text-red-500\"> * </span>\n          </span>\n          <FormControl\n            v-model=\"subject\"\n            type=\"text\"\n            placeholder=\"A short description\"\n          />\n        </div>\n        <SearchArticles\n          v-if=\"isCustomerPortal\"\n          :query=\"subject\"\n          class=\"shadow\"\n        />\n        <div v-if=\"isCustomerPortal\">\n          <h4\n            v-show=\"subject.length <= 2 && description.length === 0\"\n            class=\"text-p-sm text-gray-500 ml-1\"\n          >\n            Please enter a subject to continue\n          </h4>\n          <TicketTextEditor\n            v-show=\"subject.length > 2 || description.length > 0\"\n            ref=\"editor\"\n            v-model:attachments=\"attachments\"\n            v-model:content=\"description\"\n            placeholder=\"Detailed explanation\"\n            expand\n          >\n            <template #bottom-right>\n              <Button\n                label=\"Submit\"\n                theme=\"gray\"\n                variant=\"solid\"\n                :disabled=\"\n                  $refs.editor.editor.isEmpty || ticket.loading || !subject\n                \"\n                @click=\"() => ticket.submit()\"\n              />\n            </template>\n          </TicketTextEditor>\n        </div>\n      </div>\n\n      <!-- for agent portal -->\n      <div v-if=\"!isCustomerPortal\">\n        <TicketTextEditor\n          ref=\"editor\"\n          v-model:attachments=\"attachments\"\n          v-model:content=\"description\"\n          placeholder=\"Detailed explanation\"\n          expand\n        >\n          <template #bottom-right>\n            <Button\n              label=\"Submit\"\n              theme=\"gray\"\n              variant=\"solid\"\n              :disabled=\"\n                $refs.editor.editor.isEmpty || ticket.loading || !subject\n              \"\n              @click=\"() => ticket.submit()\"\n            />\n          </template>\n        </TicketTextEditor>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script setup lang=\"ts\">\nimport { ref, computed, reactive, onMounted } from \"vue\";\nimport { useRoute, useRouter } from \"vue-router\";\nimport {\n  createResource,\n  usePageMeta,\n  Button,\n  FormControl,\n  Breadcrumbs,\n  call,\n} from \"frappe-ui\";\nimport { globalStore } from \"@/stores/globalStore\";\nimport sanitizeHtml from \"sanitize-html\";\nimport { isEmpty } from \"lodash\";\nimport {\n  setupCustomizations,\n  handleSelectFieldUpdate,\n  handleLinkFieldUpdate,\n  parseField,\n} from \"@/composables/formCustomisation\";\nimport { LayoutHeader, UniInput } from \"@/components\";\nimport SearchArticles from \"../../components/SearchArticles.vue\";\nimport TicketTextEditor from \"./TicketTextEditor.vue\";\nimport { useAuthStore } from \"@/stores/auth\";\nimport { capture } from \"@/telemetry\";\nimport { isCustomerPortal } from \"@/utils\";\nimport { Field } from \"@/types\";\n\ninterface P {\n  templateId?: string;\n}\n\nconst props = withDefaults(defineProps<P>(), {\n  templateId: \"\",\n});\n\nconst route = useRoute();\nconst router = useRouter();\nconst { $dialog } = globalStore();\n\nconst subject = ref(\"\");\nconst description = ref(\"\");\nconst attachments = ref([]);\nconst templateFields = reactive({});\n\nconst template = createResource({\n  url: \"helpdesk.helpdesk.doctype.hd_ticket_template.api.get_one\",\n  makeParams: () => ({\n    name: props.templateId || \"Default\",\n  }),\n  auto: true,\n  transform: (doc) => {\n    setupCustomizations(doc, {\n      doc: templateFields,\n      call,\n      router,\n      $dialog,\n      applyFilters,\n    });\n    setupTemplateFields(doc.fields);\n  },\n  onSuccess: (data) => {\n    description.value = data.description_template || \"\";\n    oldFields = window.structuredClone(data.fields || []);\n  },\n});\n\nfunction setupTemplateFields(fields) {\n  fields.forEach((field: Field) => {\n    templateFields[field.fieldname] = \"\";\n  });\n}\n\nlet oldFields = [];\n\nfunction applyFilters(fieldname: string, filters: any = null) {\n  const f: Field = template.data.fields.find((f) => f.fieldname === fieldname);\n  if (!f) return;\n  if (f.fieldtype === \"Select\") {\n    handleSelectFieldUpdate(f, fieldname, filters, templateFields, oldFields);\n  } else if (f.fieldtype === \"Link\") {\n    handleLinkFieldUpdate(f, fieldname, filters, templateFields, oldFields);\n  }\n}\n\nconst customOnChange = computed(() => template.data?._customOnChange);\n\nconst visibleFields = computed(() => {\n  let _fields = template.data?.fields?.filter(\n    (f) => route.meta.agent || !f.hide_from_customer\n  );\n  if (!_fields) return [];\n  return _fields.map((field) => parseField(field, templateFields));\n});\n\nfunction handleOnFieldChange(e: any, fieldname: string, fieldtype: string) {\n  templateFields[fieldname] = e.value;\n  const fieldDependentFns = customOnChange.value?.[fieldname];\n  if (fieldDependentFns) {\n    fieldDependentFns.forEach((fn: Function) => {\n      fn(e.value, fieldtype);\n    });\n  }\n}\n\nconst ticket = createResource({\n  url: \"helpdesk.helpdesk.doctype.hd_ticket.api.new\",\n  debounce: 300,\n  makeParams: () => ({\n    doc: {\n      description: description.value,\n      subject: subject.value,\n      template: props.templateId,\n      ...templateFields,\n    },\n    attachments: attachments.value,\n  }),\n  validate: (params) => {\n    const fields = visibleFields.value?.filter((f) => f.required) || [];\n    const toVerify = [...fields, \"subject\", \"description\"];\n    for (const field of toVerify) {\n      if (isEmpty(params.doc[field.fieldname || field])) {\n        return `${field.label || field} is required`;\n      }\n    }\n  },\n  onSuccess: (data) => {\n    router.push({\n      name: isCustomerPortal.value ? \"TicketCustomer\" : \"TicketAgent\",\n      params: {\n        ticketId: data.name,\n      },\n    });\n    if (!isCustomerPortal.value) return;\n    // only capture telemetry for customer portal\n    capture(\"new_ticket_submitted\", {\n      data: {\n        user: userID,\n        ticketID: data.name,\n        subject: subject.value,\n        description: description.value,\n        customFields: templateFields,\n      },\n    });\n  },\n});\n\nfunction sanitize(html: string) {\n  return sanitizeHtml(html, {\n    allowedTags: sanitizeHtml.defaults.allowedTags.concat([\"img\"]),\n  });\n}\n\nconst breadcrumbs = computed(() => {\n  const items = [\n    {\n      label: \"Tickets\",\n      route: {\n        name: \"TicketsCustomer\",\n      },\n    },\n    {\n      label: \"New Ticket\",\n      route: {\n        name: \"TicketNew\",\n      },\n    },\n  ];\n  return items;\n});\n\nusePageMeta(() => ({\n  title: \"New Ticket\",\n}));\n\nconst { userId: userID } = useAuthStore();\nonMounted(() => {\n  capture(\"new_ticket_page\", {\n    data: {\n      user: userID,\n    },\n  });\n});\n</script>\n"],"names":["props","__props","emit","__emit","component","computed","h","Autocomplete","apiOptions","Link","o","FormControl","createResource","data","transValue","placeholder","emitUpdate","fieldname","value","route","useRoute","router","useRouter","$dialog","globalStore","subject","ref","description","attachments","templateFields","reactive","template","doc","setupCustomizations","call","applyFilters","setupTemplateFields","oldFields","fields","field","filters","f","handleSelectFieldUpdate","handleLinkFieldUpdate","customOnChange","_a","visibleFields","_fields","_b","parseField","handleOnFieldChange","fieldtype","fieldDependentFns","fn","ticket","params","toVerify","isEmpty","isCustomerPortal","capture","userID","sanitize","html","sanitizeHtml","breadcrumbs","usePageMeta","useAuthStore","onMounted"],"mappings":"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"}